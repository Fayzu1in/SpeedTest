<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SpeedTest</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div id="wrapper">
      <div id="mainDiv">
        <!-- <div id="iframeDiv">
          <iframe id="iframe" src="//openspeedtest.com/Get-widget.php"></iframe>
        </div> -->
        <div id="upperDiv">
          <a href="https://allplay.uz/">
            <img id="logoImg" src="./allplayLogoWhite.png" alt=""
          /></a>
          <div class="speedChecker">
            <!-- <div class="progress-bar">
              <div class="progress"></div>
            </div> -->

            <p class="speed-text">...</p>
            <div class="ring">
              <span class="span"></span>
            </div>
            <button id="checkBtn">Check Internet Speed</button>
          </div>
        </div>
        <!-- <button id="stopBtn">Stop</button> -->

        <div id="downDiv">
          <div class="listView">
            <p id="ipSection">IP address:</p>
            <div id="serverList" class="list first">
              <div class="leftSide">Server:</div>
              <div id="serverRight">91.234.218.52</div>
            </div>
            <div id="clientList" class="list">
              <div class="leftSide">Client:</div>
              <div id="clientRight"></div>
            </div>
            <div id="xIpList" class="list">
              <div class="leftSide">X-Ip-Region:</div>
              <div id="xIpRight"></div>
            </div>
            <div id="xSiteList" class="list">
              <div class="leftSide">X-Site-Region:</div>
              <div id="xSiteRight"></div>
            </div>
          </div>
        </div>
        <button class="copyBtn" onclick="copyText('clientRight')">
          Copy IP
        </button>
      </div>
    </div>

    <script>
      let download;

      function copyText(elementId) {
        let aux = document.createElement("input");
        aux.setAttribute("value", document.getElementById(elementId).innerHTML);
        document.body.appendChild(aux);
        aux.select();
        document.execCommand("copy");
        document.body.removeChild(aux);
      }

      let request;
      let ipInfo;
      if (window.XMLHttpRequest) {
        request = new XMLHttpRequest();
      } else {
        request = new ActiveXObject();
      }
      request.open("GET", "https://api.allplay.uz/api/v1/region");
      request.responseType = "json";
      request.onreadystatechange = function () {
        if (request.readyState === 4) {
          ipInfo = request.response;
          document.getElementById(
            "clientRight"
          ).innerHTML = `${ipInfo.data.ip}`;
          document.getElementById(
            "xIpRight"
          ).innerHTML = `${ipInfo.data.ip_region}`;
          document.getElementById(
            "xSiteRight"
          ).innerHTML = `${ipInfo.data.site_region}`;
        }
      };
      request.send();

      const button = document.querySelector("button");
      const size = 178000000 * 8;
      const TEST_COUNT = 1000;
      const progress = document.querySelector(".progress");
      const speedText = document.querySelector(".speed-text");

      let test_results = [];

      function loadVideo() {
        return new Promise((resolve, reject) => {
          //   let image = new Image();
          download = document.createElement("video");
          download.src =
            "https://st9.allmovies.uz/t/e/1/e1hw7vx4sa3qheqg22kvhae3.mp4";
          // parseInt(Math.random() * 10000);
          //   image.src = "./test.gif?" + parseInt(Math.random() * 10000);
          let startTime = Date.now();

          download.onloadeddata = function () {
            let endTime = Date.now();
            resolve(endTime - startTime);
          };

          download.onerror = function (err) {
            reject(err);
          };
        });
      }

      async function getLoadSpeed() {
        let loadTime = await loadVideo();
        if (loadTime < 1) loadTime = 1;
        let speed_bps = size / loadTime;
        let speed_kbps = speed_bps / 1024;
        let speedMb = speed_kbps / 1024;

        return speedMb;
      }

      function getAvgSpeed() {
        let sum = test_results.reduce((a, b) => a + b, 0);

        return sum / test_results.length;
      }

      checkBtn.addEventListener("click", async function () {
        // setTimeout(stop, 10000);
        try {
          for (let i = 0; i < TEST_COUNT; i++) {
            let speed = await getLoadSpeed();
            test_results.push(speed);
            // progress.style.width = ((i + 1) / TEST_COUNT) * 100 + "%";

            speedText.innerText = getAvgSpeed().toFixed(2) + "Mb";
          }

          document.querySelector(".ring").style.display = "none";
          speedText.style.transform = "scale(2)";
        } catch (e) {
          console.log(e);
          document.querySelector(".ring").style.display = "none";
          speedText.style.transform = "scale(2)";
        }
      });

      checkBtn.addEventListener("click", function () {
        document.getElementById("logoImg").style.display = "none";
        document.getElementById("checkBtn").style.display = "none";
        document.querySelector(".ring").style.display = "inline-block";
        // document.getElementById("stopBtn").style.display = "block";
      });

      // prelearnBtn.addEventListener("click", function () {
      //   setTimeout(function () {
      //     player1.api("play");
      //   }, 3000);
      // });

      // function stop() {
      //   console.log(download);
      //   // let tmp = download.get(0);
      //   download.pause();
      //   download.src = "";
      //   download.load();
      //   download.remove();
      // }

      // document.getElementById("stopBtn").addEventListener("click", stop);
    </script>
  </body>
</html>
